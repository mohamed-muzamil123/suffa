<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Media & Announcement Panel - Fest Management Software</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      }
      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(to bottom, #f0f2f5, #ffffff);
        min-height: 100vh;
      }
      .header {
        background: var(--primary-gradient);
        color: white;
        padding: 1rem 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }
      .search-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }
      .programme-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        margin-bottom: 1rem;
      }
      .programme-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      }
      .status-badge {
        font-size: 0.75rem;
      }
      .table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      }
      .table thead th {
        background: var(--primary-gradient);
        color: white;
        border: none;
        font-weight: 600;
      }
      .table tbody tr:hover {
        background: rgba(102, 126, 234, 0.05);
      }
      .btn {
        border-radius: 25px;
        padding: 0.5rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      .modal-content {
        border-radius: 20px;
        border: none;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      }
      .form-control,
      .form-select {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        transition: border-color 0.3s ease;
      }
      .form-control:focus,
      .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }
      .toast-container {
        z-index: 1055;
      }
      @media (max-width: 768px) {
        .programme-card {
          margin-bottom: 1rem;
        }
      }

      .logo-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .logo-img {
        max-height: 50px;
        max-width: 80px;
        width: auto;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
        margin-bottom: 0.25rem; /* Space under logo for fest name */
      }

      .logo-img:hover {
        transform: scale(1.05);
      }

      .fest-name {
        color: white;
        font-weight: 600;
        font-size: 0.85rem;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        letter-spacing: 1px;
        margin: 0;
      }

      /* Mobile: Full stack for header */
      @media (max-width: 768px) {
        .logo-container {
          margin-bottom: 0.5rem;
        }

        .logo-img {
          max-height: 40px;
          max-width: 60px;
        }

        .fest-name {
          font-size: 0.75rem;
        }

        .d-flex.align-items-center h1 {
          font-size: 1.25rem;
          text-align: center;
          width: 100%;
        }

        .header {
          padding: 1rem;
          text-align: center;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="d-flex justify-content-between align-items-center">
        <!-- Logo and Fest Name (Stacked) -->
        <div class="d-flex align-items-center">
          <div class="logo-container me-3">
            <img src="logo.png" alt="    Logo" class="logo-img" />
            <p class="fest-name mb-0"></p>
          </div>
          <h1 class="mb-0 fw-bold">Media & Announcement Panel</h1>
        </div>
      </div>
    </header>

    <main class="container-fluid p-4">
      <!-- Search & Filter Section -->
      <div class="search-section">
        <h2 class="mb-3 fw-bold text-dark">Finalized Programme Results</h2>
        <div class="row mb-3">
          <div class="col-md-3">
            <input
              type="text"
              class="form-control"
              id="resultSearch"
              placeholder="Search by result number, category, or programme name..."
              onkeyup="filterProgrammes()"
            />
          </div>
          <div class="col-md-3">
            <select
              class="form-select"
              id="announcedFilter"
              onchange="filterProgrammes()"
            >
              <option value="">All Announced Status</option>
              <option value="true">Announced</option>
              <option value="false">Not Announced</option>
            </select>
          </div>
          <div class="col-md-3">
            <select
              class="form-select"
              id="postedFilter"
              onchange="filterProgrammes()"
            >
              <option value="">All Posted Status</option>
              <option value="true">Posted</option>
              <option value="false">Not Posted</option>
            </select>
          </div>
          <div class="col-md-3">
            <select
              class="form-select"
              id="categoryFilter"
              onchange="filterProgrammes()"
            >
              <option value="">All Categories</option>
            </select>
          </div>
        </div>
        <div id="programmeCards" class="row"></div>
      </div>
    </main>

    <!-- View Results Modal -->
    <div class="modal fade" id="viewModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="modalTitle">Programme Results</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Place</th>
                    <th>Code Letter</th>
                    <th>Chest Number</th>
                    <th>Student Name</th>
                    <th>Team</th>
                    <th>Grade</th>
                    <th>Points</th>
                  </tr>
                </thead>
                <tbody id="resultsTbody"></tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              onclick="exportResults()"
            >
              Export
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
      <div
        id="liveToast"
        class="toast align-items-center text-white bg-success border-0"
        role="alert"
      >
        <div class="d-flex">
          <div class="toast-body" id="toastBody"></div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
          ></button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        getDoc,
        updateDoc,
        query,
        where,
        onSnapshot,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

      const firebaseConfig = {
  apiKey: "AIzaSyC1gEEprODHX63Rbd3eKAbzef7JSz7e4yc",
  authDomain: "suffa-b3b9f.firebaseapp.com",
  projectId: "suffa-b3b9f",
  storageBucket: "suffa-b3b9f.firebasestorage.app",
  messagingSenderId: "1062460671442",
  appId: "1:1062460671442:web:a5a81bf77c4a08061bb40b"
};

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      let finalizedProgrammes = [];
      let categories = [];
      let students = [];
      let unsubscribeProgrammes = null;
      let unsubscribeCategories = null;
      let unsubscribeStudents = null;
      let currentProgrammeId = null;
      let currentProg = null;

      // Utils
      window.showToast = function (message, type = "success") {
        const toastEl = document.getElementById("liveToast");
        const toastBody = document.getElementById("toastBody");
        toastBody.textContent = message;
        toastEl.className = `toast align-items-center text-white bg-${
          type === "success" ? "success" : "danger"
        } border-0`;
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
      };

      function loadStudents() {
        if (unsubscribeStudents) unsubscribeStudents();
        const q = query(collection(db, "students"), orderBy("chestNo"));
        unsubscribeStudents = onSnapshot(q, (snapshot) => {
          students = snapshot.docs.map((d) => ({ id: d.id, ...d.data() }));
        });
      }

      function loadCategories() {
        if (unsubscribeCategories) unsubscribeCategories();
        const q = query(collection(db, "categories"), orderBy("serial"));
        unsubscribeCategories = onSnapshot(q, (snapshot) => {
          categories = snapshot.docs.map((d) => ({ id: d.id, ...d.data() }));
          populateCategoryFilter();
        });
      }

      function populateCategoryFilter() {
        const select = document.getElementById("categoryFilter");
        select.innerHTML = '<option value="">All Categories</option>';
        categories.forEach((cat) => {
          const option = new Option(cat.name, cat.name);
          select.add(option);
        });
      }

      function loadFinalizedProgrammes() {
        if (unsubscribeProgrammes) unsubscribeProgrammes();
        const q = query(
          collection(db, "programmes"),
          where("finalized", "==", true),
          orderBy("finalizedAt")
        );
        unsubscribeProgrammes = onSnapshot(q, (snapshot) => {
          finalizedProgrammes = snapshot.docs.map((d) => ({
            id: d.id,
            ...d.data(),
          }));
          // Assign result number based on order
          finalizedProgrammes.forEach(
            (p, index) => (p.resultNumber = index + 1)
          );
          filterProgrammes();
        });
      }

      window.filterProgrammes = function () {
        const search = document
          .getElementById("resultSearch")
          .value.toLowerCase();
        const announcedFilter =
          document.getElementById("announcedFilter").value;
        const postedFilter = document.getElementById("postedFilter").value;
        const categoryFilter = document.getElementById("categoryFilter").value;
        const filtered = finalizedProgrammes.filter(
          (p) =>
            (p.resultNumber.toString().includes(search) ||
              p.category.toLowerCase().includes(search) ||
              p.name.toLowerCase().includes(search)) &&
            (announcedFilter === "" ||
              Boolean(p.announced) === (announcedFilter === "true")) &&
            (postedFilter === "" ||
              Boolean(p.posted) === (postedFilter === "true")) &&
            (!categoryFilter || p.category === categoryFilter)
        );
        renderProgrammeCards(filtered);
      };

      function renderProgrammeCards(progs) {
        const container = document.getElementById("programmeCards");
        if (progs.length === 0) {
          container.innerHTML =
            '<div class="col-12"><div class="alert alert-info text-center">No finalized programmes found.</div></div>';
          return;
        }
        container.innerHTML = progs
          .map(
            (p) => `
                <div class="col-md-4">
                    <div class="programme-card">
                        <h5 class="fw-bold">Result #${p.resultNumber}</h5>
                        <p class="text-muted">${p.category} - ${p.name}</p>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="status-badge badge ${
                              p.announced ? "bg-success" : "bg-secondary"
                            }">${
              p.announced ? "Announced" : "Not Announced"
            }</span>
                            <span class="status-badge badge ${
                              p.posted ? "bg-success" : "bg-secondary"
                            }">${p.posted ? "Posted" : "Not Posted"}</span>
                        </div>
                        ${
                          !p.announced
                            ? `<button class="btn btn-outline-primary btn-sm me-1" onclick="markAnnounced('${p.id}')">Announce</button>`
                            : ""
                        }
                        ${
                          !p.posted
                            ? `<button class="btn btn-outline-success btn-sm me-1" onclick="markPosted('${p.id}')">Post</button>`
                            : ""
                        }
                        <button class="btn btn-info btn-sm" onclick="openViewPopup('${
                          p.id
                        }')">View</button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      window.markAnnounced = function (progId) {
        if (
          confirm("Are you sure you want to mark this programme as announced?")
        ) {
          updateStatus(progId, "announced", true);
        }
      };

      window.markPosted = function (progId) {
        if (
          confirm("Are you sure you want to mark this programme as posted?")
        ) {
          updateStatus(progId, "posted", true);
        }
      };

      async function updateStatus(progId, field, value) {
        try {
          await updateDoc(doc(db, "programmes", progId), {
            [field]: value,
            [`${field}At`]: new Date(),
          });
          showToast(
            `${field === "announced" ? "Announced" : "Posted"} successfully`
          );
        } catch (error) {
          showToast(`Error updating ${field}: ${error.message}`, "danger");
        }
      }

      window.openViewPopup = async function (progId) {
        currentProgrammeId = progId;
        const progDoc = await getDoc(doc(db, "programmes", progId));
        if (!progDoc.exists()) return;
        const progData = progDoc.data();
        const resultNumber = finalizedProgrammes.find(
          (p) => p.id === progId
        )?.resultNumber;
        currentProg = { ...progData, resultNumber };
        document.getElementById(
          "modalTitle"
        ).textContent = `${progData.category} - ${progData.name}`;
        renderResultsTable(progData);
        new bootstrap.Modal(document.getElementById("viewModal")).show();
      };

      function renderResultsTable(prog) {
        const marksDetails = prog.marksDetails || {};
        const codeLetters = prog.codeLetters || {};
        const studentEntries = Object.keys(codeLetters)
          .map((studentId) => {
            const details = marksDetails[studentId] || {
              place: null,
              grade: "No Grade",
              points: 0,
              codeLetter: codeLetters[studentId],
            };
            const student = students.find((s) => s.id === studentId);
            if (!student) return null;
            const hasPlace = !!details.place;
            const hasGrade = !!details.grade && details.grade !== "No Grade";
            const hasPoints = details.points > 0;
            const placeOrdinal = details.place
              ? `${details.place}${
                  ["st", "nd", "rd"][Math.min(2, details.place - 1)]
                }`
              : "-";
            return {
              place: details.place || null,
              placeDisplay: placeOrdinal,
              codeLetter: codeLetters[studentId] || details.codeLetter,
              chestNo: student.chestNo,
              name: student.name,
              team: student.team,
              grade: details.grade,
              points: details.points,
            };
          })
          .filter(Boolean);
        studentEntries.sort((a, b) => {
          if (a.place !== null && b.place !== null) {
            return a.place - b.place;
          } else if (a.place !== null) {
            return -1;
          } else if (b.place !== null) {
            return 1;
          } else {
            return b.points - a.points;
          }
        });

        const tbody = document.getElementById("resultsTbody");
        tbody.innerHTML = studentEntries
          .map(
            (entry) => `
                <tr>
                    <td>${entry.placeDisplay}</td>
                    <td>${entry.codeLetter}</td>
                    <td>${entry.chestNo}</td>
                    <td>${entry.name}</td>
                    <td>${entry.team}</td>
                    <td>${entry.grade}</td>
                    <td>${entry.points}</td>
                </tr>
            `
          )
          .join("");
      }

      window.exportResults = function () {
        if (!currentProg) {
          showToast("No programme selected for export", "danger");
          return;
        }

        const marksDetails = currentProg.marksDetails || {};
        const codeLetters = currentProg.codeLetters || {};
        const studentEntries = Object.keys(codeLetters)
          .map((studentId) => {
            const details = marksDetails[studentId] || {
              place: null,
              grade: "No Grade",
              points: 0,
              codeLetter: codeLetters[studentId],
            };
            const student = students.find((s) => s.id === studentId);
            if (!student) return null;
            const hasPlace = !!details.place;
            const hasGrade = !!details.grade && details.grade !== "No Grade";
            const hasPoints = details.points > 0;
            const placeOrdinal = details.place
              ? `${details.place}${
                  ["st", "nd", "rd"][Math.min(2, details.place - 1)]
                }`
              : "-";
            return {
              place: details.place || null,
              placeDisplay: placeOrdinal,
              codeLetter: codeLetters[studentId] || details.codeLetter,
              chestNo: student.chestNo,
              name: student.name,
              team: student.team,
              grade: details.grade,
              points: details.points,
            };
          })
          .filter(Boolean);
        studentEntries.sort((a, b) => {
          if (a.place !== null && b.place !== null) {
            return a.place - b.place;
          } else if (a.place !== null) {
            return -1;
          } else if (b.place !== null) {
            return 1;
          } else {
            return b.points - a.points;
          }
        });

        const tableRows = studentEntries
          .map(
            (entry) => `
                <tr>
                    <td>${entry.placeDisplay}</td>
                    <td>${entry.codeLetter}</td>
                    <td>${entry.chestNo}</td>
                    <td>${entry.name}</td>
                    <td>${entry.team}</td>
                    <td>${entry.grade}</td>
                    <td>${entry.points}</td>
                </tr>
            `
          )
          .join("");

        const printWindow = window.open("", "_blank", "width=800,height=600");
        printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Export Results - ${currentProg.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        @page {
                            size: A4;
                            margin: 1in;
                        }
                        body {
                            font-family: 'Inter', sans-serif;
                            font-size: 12pt;
                            line-height: 1.4;
                            color: #333;
                            max-width: 210mm;
                            margin: 0 auto;
                        }
                        h1 {
                            text-align: center;
                            font-size: 24pt;
                            font-weight: bold;
                            margin-bottom: 1rem;
                            page-break-after: avoid;
                        }
                        h2 {
                            text-align: center;
                            font-size: 16pt;
                            font-weight: 600;
                            margin-bottom: 2rem;
                            page-break-after: avoid;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 1rem;
                        }
                        th, td {
                            border: 1px solid #ddd;
                            padding: 8px;
                            text-align: left;
                        }
                        th {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            font-weight: 600;
                        }
                        @media print {
                            body { -webkit-print-color-adjust: exact; }
                            th { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Result #${currentProg.resultNumber}</h1>
                    <h2>${currentProg.category} - ${currentProg.name}</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Place</th>
                                <th>Code Letter</th>
                                <th>Chest Number</th>
                                <th>Student Name</th>
                                <th>Team</th>
                                <th>Grade</th>
                                <th>Points</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    <script>
                        window.onload = function() {
                            window.print();
                        };
                 
            `);
        printWindow.document.close();
      };

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadStudents();
        loadCategories();
        loadFinalizedProgrammes();
        document.getElementById("programmeCards").innerHTML =
          '<div class="col-12"><div class="alert alert-info text-center">Loading finalized programmes...</div></div>';
      });
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
