<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prizing Panel - Fest Management Software</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      }
      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(to bottom, #f0f2f5, #ffffff);
        min-height: 100vh;
      }
      .header {
        background: var(--primary-gradient);
        color: white;
        padding: 1rem 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }
      .search-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }
      .programme-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        margin-bottom: 1rem;
      }
      .programme-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      }
      .status-badge {
        font-size: 0.75rem;
      }
      .table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      }
      .table thead th {
        background: var(--primary-gradient);
        color: white;
        border: none;
        font-weight: 600;
      }
      .table tbody tr:hover {
        background: rgba(102, 126, 234, 0.05);
      }
      .btn {
        border-radius: 25px;
        padding: 0.5rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      .modal-content {
        border-radius: 20px;
        border: none;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      }
      .form-control,
      .form-select {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        transition: border-color 0.3s ease;
      }
      .form-control:focus,
      .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }
      .toast-container {
        z-index: 1055;
      }
      @media (max-width: 768px) {
        .programme-card {
          margin-bottom: 1rem;
        }
      }

      .logo-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .logo-img {
        max-height: 50px;
        max-width: 80px;
        width: auto;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
        margin-bottom: 0.25rem; /* Space under logo for fest name */
      }

      .logo-img:hover {
        transform: scale(1.05);
      }

      .fest-name {
        color: white;
        font-weight: 600;
        font-size: 0.85rem;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        letter-spacing: 1px;
        margin: 0;
      }

      /* Mobile: Full stack for header */
      @media (max-width: 768px) {
        .logo-container {
          margin-bottom: 0.5rem;
        }

        .logo-img {
          max-height: 40px;
          max-width: 60px;
        }

        .fest-name {
          font-size: 0.75rem;
        }

        .d-flex.align-items-center h1 {
          font-size: 1.25rem;
          text-align: center;
          width: 100%;
        }

        .header {
          padding: 1rem;
          text-align: center;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="d-flex justify-content-between align-items-center">
        <!-- Logo and Fest Name (Stacked) -->
        <div class="d-flex align-items-center">
          <div class="logo-container me-3">
            <img src="logo.png" alt="    Logo" class="logo-img" />
            <p class="fest-name mb-0"></p>
          </div>
          <h1 class="mb-0 fw-bold">Prizing Panel</h1>
        </div>
      </div>
    </header>

    <main class="container-fluid p-4">
      <!-- Search & Filter Section -->
      <div class="search-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="fw-bold text-dark mb-0">Finalized Programme Results</h2>
          <button class="btn btn-primary" onclick="exportWinners()">
            Export
          </button>
        </div>
        <div class="row mb-3">
          <div class="col-md-9">
            <input
              type="text"
              class="form-control"
              id="prizeSearch"
              placeholder="Search by category or programme name..."
              onkeyup="filterProgrammes()"
            />
          </div>
          <div class="col-md-3">
            <select
              class="form-select"
              id="prizedFilter"
              onchange="filterProgrammes()"
            >
              <option value="">All Prize Status</option>
              <option value="true">Prized</option>
              <option value="false">Not Prized</option>
            </select>
          </div>
        </div>
        <div id="programmeCards" class="row"></div>
      </div>
    </main>

    <!-- View Top 3 Ranks Modal -->
    <div class="modal fade" id="viewModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="modalTitle">Top 3 Ranks</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Place</th>
                    <th>Chest Number</th>
                    <th>Student Name</th>
                    <th>Team</th>
                  </tr>
                </thead>
                <tbody id="resultsTbody"></tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
      <div
        id="liveToast"
        class="toast align-items-center text-white bg-success border-0"
        role="alert"
      >
        <div class="d-flex">
          <div class="toast-body" id="toastBody"></div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
          ></button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        doc,
        getDoc,
        updateDoc,
        query,
        where,
        onSnapshot,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

      const firebaseConfig = {
  apiKey: "AIzaSyC1gEEprODHX63Rbd3eKAbzef7JSz7e4yc",
  authDomain: "suffa-b3b9f.firebaseapp.com",
  projectId: "suffa-b3b9f",
  storageBucket: "suffa-b3b9f.firebasestorage.app",
  messagingSenderId: "1062460671442",
  appId: "1:1062460671442:web:a5a81bf77c4a08061bb40b"
};

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      let finalizedProgrammes = [];
      let students = [];
      let currentFilteredProgrammes = [];
      let unsubscribeProgrammes = null;
      let unsubscribeStudents = null;
      let currentProgrammeId = null;

      function getOrdinal(n) {
        if (n == 1) return "1st";
        if (n == 2) return "2nd";
        if (n == 3) return "3rd";
        return n.toString();
      }

      // Utils
      window.showToast = function (message, type = "success") {
        const toastEl = document.getElementById("liveToast");
        const toastBody = document.getElementById("toastBody");
        toastBody.textContent = message;
        toastEl.className = `toast align-items-center text-white bg-${
          type === "success" ? "success" : "danger"
        } border-0`;
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
      };

      function loadStudents() {
        if (unsubscribeStudents) unsubscribeStudents();
        const q = query(collection(db, "students"), orderBy("chestNo"));
        unsubscribeStudents = onSnapshot(q, (snapshot) => {
          students = snapshot.docs.map((d) => ({ id: d.id, ...d.data() }));
        });
      }

      function loadFinalizedProgrammes() {
        if (unsubscribeProgrammes) unsubscribeProgrammes();
        const q = query(
          collection(db, "programmes"),
          where("finalized", "==", true),
          orderBy("finalizedAt")
        );
        unsubscribeProgrammes = onSnapshot(q, (snapshot) => {
          let allProgs = snapshot.docs.map((d) => ({ id: d.id, ...d.data() }));
          finalizedProgrammes = allProgs.filter((p) => {
            const marksDetails = p.marksDetails || {};
            return Object.values(marksDetails).some(
              (d) => d.place && d.place >= 1 && d.place <= 3
            );
          });
          // Assign result number based on order
          finalizedProgrammes.forEach(
            (p, index) => (p.resultNumber = index + 1)
          );
          filterProgrammes();
        });
      }

      window.filterProgrammes = function () {
        const search = document
          .getElementById("prizeSearch")
          .value.toLowerCase();
        const prizedFilter = document.getElementById("prizedFilter").value;
        const filtered = finalizedProgrammes.filter(
          (p) =>
            (p.category.toLowerCase().includes(search) ||
              p.name.toLowerCase().includes(search)) &&
            (prizedFilter === "" ||
              (prizedFilter === "true" && p.prized === true) ||
              (prizedFilter === "false" && p.prized !== true))
        );
        currentFilteredProgrammes = filtered;
        renderProgrammeCards(filtered);
      };

      function renderProgrammeCards(progs) {
        const container = document.getElementById("programmeCards");
        if (progs.length === 0) {
          container.innerHTML =
            '<div class="col-12"><div class="alert alert-info text-center">No finalized programmes found matching the criteria.</div></div>';
          return;
        }
        container.innerHTML = progs
          .map(
            (p) => `
                <div class="col-md-4">
                    <div class="programme-card">
                        <h5 class="fw-bold">Result #${p.resultNumber}</h5>
                        <p class="text-muted">${p.category} - ${p.name}</p>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="status-badge badge ${
                              p.prized ? "bg-success" : "bg-secondary"
                            }">${p.prized ? "Prized" : "Not Prized"}</span>
                        </div>
                        ${
                          !p.prized
                            ? `<button class="btn btn-outline-success btn-sm me-1" onclick="markPrized('${p.id}')">Mark as Prized</button>`
                            : ""
                        }
                        <button class="btn btn-info btn-sm" onclick="openViewPopup('${
                          p.id
                        }')">View</button>
                    </div>
                </div>
            `
          )
          .join("");
      }

      window.markPrized = function (progId) {
        if (confirm("Are you sure you want to mark prizes as distributed?")) {
          updateStatus(progId, "prized", true);
        }
      };

      async function updateStatus(progId, field, value) {
        try {
          await updateDoc(doc(db, "programmes", progId), {
            [field]: value,
            [`${field}At`]: new Date(),
          });
          showToast("Prizes distributed successfully");
        } catch (error) {
          showToast(`Error updating ${field}: ${error.message}`, "danger");
        }
      }

      window.openViewPopup = async function (progId) {
        currentProgrammeId = progId;
        const progDoc = await getDoc(doc(db, "programmes", progId));
        if (!progDoc.exists()) return;
        const prog = progDoc.data();
        document.getElementById(
          "modalTitle"
        ).textContent = `Top 3 Ranks - ${prog.category} - ${prog.name}`;
        renderTop3Table(prog);
        new bootstrap.Modal(document.getElementById("viewModal")).show();
      };

      function renderTop3Table(prog) {
        const marksDetails = prog.marksDetails || {};
        const studentEntries = Object.entries(marksDetails)
          .filter(
            ([studentId, details]) =>
              details.place && details.place >= 1 && details.place <= 3
          )
          .map(([studentId, details]) => {
            const student = students.find((s) => s.id === studentId);
            if (!student) return null;
            return {
              placeNum: details.place,
              place: getOrdinal(details.place),
              chestNo: student.chestNo,
              name: student.name,
              team: student.team,
            };
          })
          .filter(Boolean)
          .sort(
            (a, b) => a.placeNum - b.placeNum || a.name.localeCompare(b.name)
          );

        const tbody = document.getElementById("resultsTbody");
        tbody.innerHTML = studentEntries
          .map(
            (entry) => `
                <tr>
                    <td>${entry.place}</td>
                    <td>${entry.chestNo}</td>
                    <td>${entry.name}</td>
                    <td>${entry.team}</td>
                </tr>
            `
          )
          .join("");
      }

      window.exportWinners = function () {
        if (currentFilteredProgrammes.length === 0) {
          showToast("No programmes to export");
          return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 40;
        // Main heading
        doc.setFontSize(24);
        doc.setTextColor(255, 255, 255);
        doc.setFillColor(102, 126, 234);
        doc.rect(10, 10, 190, 15, "F");
        doc.text("Winners", 105, 20, { align: "center" });
        y = 40;
        for (let prog of currentFilteredProgrammes) {
          // Subheading
          if (y > 270) {
            doc.addPage();
            y = 20;
          }
          doc.setFontSize(16);
          doc.setFillColor(102, 126, 234);
          doc.rect(10, y, 190, 10, "F");
          doc.setTextColor(255, 255, 255);
          doc.text(`${prog.category} - ${prog.name}`, 105, y + 6, {
            align: "center",
          });
          y += 15;
          // Table
          const marksDetails = prog.marksDetails || {};
          const studentEntries = Object.entries(marksDetails)
            .filter(
              ([_, details]) =>
                details.place && details.place >= 1 && details.place <= 3
            )
            .map(([studentId, details]) => {
              const student = students.find((s) => s.id === studentId);
              if (!student) return null;
              return {
                placeNum: details.place,
                place: getOrdinal(details.place),
                chestNo: student.chestNo,
                name: student.name,
                team: student.team,
              };
            })
            .filter(Boolean)
            .sort((a, b) => a.placeNum - b.placeNum);
          if (studentEntries.length > 0) {
            const tableData = studentEntries.map((e) => [
              e.place,
              e.chestNo,
              e.name,
              e.team,
            ]);
            doc.autoTable({
              head: [["Place", "Chest Number", "Student Name", "Team"]],
              body: tableData,
              startY: y,
              headStyles: {
                fillColor: [102, 126, 234],
                textColor: 255,
                fontSize: 12,
                fontStyle: "bold",
              },
              styles: {
                fontSize: 10,
                cellPadding: 3,
              },
              margin: { left: 10, right: 10 },
              tableWidth: "auto",
            });
            y = doc.lastAutoTable.finalY + 10;
          } else {
            y += 5;
          }
        }
        doc.save("winners.pdf");

        // Generate print HTML
        let printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Winners Print</title>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        :root {
                            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        }
                        body { font-family: 'Inter', sans-serif; background: white; }
                        h1 { background: var(--primary-gradient); color: white; padding: 1rem; border-radius: 10px; margin-bottom: 2rem; }
                        h2 { background: var(--primary-gradient); color: white; padding: 0.5rem; border-radius: 5px; margin-bottom: 1rem; }
                        .table { box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); border-radius: 10px; overflow: hidden; }
                        .table thead th { background: var(--primary-gradient); color: white; font-weight: 600; border: none; }
                        .table tbody tr:hover { background: rgba(102, 126, 234, 0.05); }
                        @media print { body { -webkit-print-color-adjust: exact; } .table thead th { -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <div class="container-fluid p-4">
                        <h1 class="text-center">Winners</h1>
            `;
        currentFilteredProgrammes.forEach((prog) => {
          const marksDetails = prog.marksDetails || {};
          const studentEntries = Object.entries(marksDetails)
            .filter(
              ([_, details]) =>
                details.place && details.place >= 1 && details.place <= 3
            )
            .map(([studentId, details]) => {
              const student = students.find((s) => s.id === studentId);
              if (!student) return null;
              return {
                placeNum: details.place,
                place: getOrdinal(details.place),
                chestNo: student.chestNo,
                name: student.name,
                team: student.team,
              };
            })
            .filter(Boolean)
            .sort((a, b) => a.placeNum - b.placeNum);
          let tableRows = "";
          if (studentEntries.length > 0) {
            tableRows = studentEntries
              .map(
                (e) => `
                        <tr>
                            <td>${e.place}</td>
                            <td>${e.chestNo}</td>
                            <td>${e.name}</td>
                            <td>${e.team}</td>
                        </tr>
                    `
              )
              .join("");
          }
          printHTML += `
                        <h2 class="text-center">${prog.category} - ${prog.name}</h2>
                        <div class="table-responsive mb-4">
                            <table class="table table-hover">
                                <thead><tr><th>Place</th><th>Chest Number</th><th>Student Name</th><th>Team</th></tr></thead>
                                <tbody>${tableRows}</tbody>
                            </table>
                        </div>
                `;
        });
        printHTML += `
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            window.onafterprint = function() {
                                window.close();
                            };
                        };
             
            `;
        const printWindow = window.open("", "_blank");
        printWindow.document.write(printHTML);
        printWindow.document.close();

        showToast("PDF exported and print dialog opened");
      };

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadStudents();
        loadFinalizedProgrammes();
        document.getElementById("programmeCards").innerHTML =
          '<div class="col-12"><div class="alert alert-info text-center">Loading finalized programmes...</div></div>';
      });
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
